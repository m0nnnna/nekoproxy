{% extends "base.html" %}

{% block title %}Statistics - NekoProxy{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Statistics</h1>
</div>

<!-- Proxy Connection Stats -->
<h2 class="text-lg font-semibold text-gray-900 mb-4">Proxy Connections (24h)</h2>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Total Connections</div>
        <div class="mt-2 text-3xl font-semibold text-gray-900">{{ summary.total_connections }}</div>
    </div>
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Blocked Connections</div>
        <div class="mt-2 text-3xl font-semibold text-red-600">{{ summary.blocked_connections }}</div>
    </div>
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Data Sent</div>
        <div class="mt-2 text-3xl font-semibold text-gray-900">
            {% set bytes = summary.total_bytes_sent %}
            {% if bytes >= 1073741824 %}
            {{ "%.2f"|format(bytes / 1073741824) }} GB
            {% elif bytes >= 1048576 %}
            {{ "%.2f"|format(bytes / 1048576) }} MB
            {% elif bytes >= 1024 %}
            {{ "%.2f"|format(bytes / 1024) }} KB
            {% else %}
            {{ bytes }} B
            {% endif %}
        </div>
    </div>
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Data Received</div>
        <div class="mt-2 text-3xl font-semibold text-gray-900">
            {% set bytes = summary.total_bytes_received %}
            {% if bytes >= 1073741824 %}
            {{ "%.2f"|format(bytes / 1073741824) }} GB
            {% elif bytes >= 1048576 %}
            {{ "%.2f"|format(bytes / 1048576) }} MB
            {% elif bytes >= 1024 %}
            {{ "%.2f"|format(bytes / 1024) }} KB
            {% else %}
            {{ bytes }} B
            {% endif %}
        </div>
    </div>
</div>

<!-- Email Proxy Stats -->
<h2 class="text-lg font-semibold text-gray-900 mb-4">Email Proxy (24h)</h2>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Emails Processed</div>
        <div class="mt-2 text-3xl font-semibold text-gray-900">{{ email_summary.total_emails }}</div>
    </div>
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Delivered</div>
        <div class="mt-2 text-3xl font-semibold text-green-600">{{ email_summary.delivered_emails }}</div>
    </div>
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Blocked</div>
        <div class="mt-2 text-3xl font-semibold text-red-600">{{ email_summary.blocked_emails }}</div>
    </div>
    <div class="bg-white shadow rounded-lg p-6">
        <div class="text-sm font-medium text-gray-500">Email Data Sent</div>
        <div class="mt-2 text-3xl font-semibold text-gray-900">
            {% set bytes = email_summary.email_bytes_sent %}
            {% if bytes >= 1073741824 %}
            {{ "%.2f"|format(bytes / 1073741824) }} GB
            {% elif bytes >= 1048576 %}
            {{ "%.2f"|format(bytes / 1048576) }} MB
            {% elif bytes >= 1024 %}
            {{ "%.2f"|format(bytes / 1024) }} KB
            {% else %}
            {{ bytes }} B
            {% endif %}
        </div>
    </div>
</div>

<!-- Connection Log -->
<div class="bg-white shadow rounded-lg overflow-hidden mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Connection Log (Last 24 hours)</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agent</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client IP</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sent</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Received</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for conn in connections %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ conn.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ conn.agent_id }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ conn.client_ip }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if conn.status == 'completed' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            {{ conn.status }}
                        </span>
                        {% elif conn.status == 'blocked' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            {{ conn.status }}
                        </span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            {{ conn.status }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ "%.2f"|format(conn.duration or 0) }}s
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ conn.bytes_sent }} B
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ conn.bytes_received }} B
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                        No connections in the last 24 hours
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Email Log -->
<div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Email Log (Last 24 hours)</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agent</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client IP</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sender</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recipient</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for email in email_connections %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ email.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ email.agent_id }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ email.client_ip }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ email.sender or '-' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ email.recipient or '-' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if email.status == 'delivered' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            {{ email.status }}
                        </span>
                        {% elif email.status == 'blocked' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            {{ email.status }}
                        </span>
                        {% elif email.status == 'bounced' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            {{ email.status }}
                        </span>
                        {% elif email.status == 'deferred' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            {{ email.status }}
                        </span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            {{ email.status }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% set bytes = email.bytes_sent + email.bytes_received %}
                        {% if bytes >= 1048576 %}
                        {{ "%.2f"|format(bytes / 1048576) }} MB
                        {% elif bytes >= 1024 %}
                        {{ "%.2f"|format(bytes / 1024) }} KB
                        {% else %}
                        {{ bytes }} B
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                        No email activity in the last 24 hours
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
